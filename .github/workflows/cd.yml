name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pip install -r requirements-dev.txt
          pytest tests/ -v -m smoke --tb=short

      - name: Create build artifacts
        run: |
          mkdir -p dist
          # Create package manifest
          echo "# E-Grocery Forecaster Build Artifacts" > dist/BUILD_INFO.txt
          echo "Version: ${{ github.ref_name }}" >> dist/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> dist/BUILD_INFO.txt
          echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> dist/BUILD_INFO.txt
          
          # Package source code
          tar -czf dist/source-code.tar.gz src/ scripts/ tests/ requirements.txt pyproject.toml

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.example.com  # Update with your staging URL
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate pipeline
        run: |
          python scripts/validate_setup.py

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add your deployment commands here
          # Examples:
          # - Deploy to cloud storage (S3, GCS, Azure Blob)
          # - Update model registry
          # - Trigger deployment pipeline
          # - Send notification

      - name: Run smoke tests on staging
        run: |
          echo "Running smoke tests on staging environment..."
          # Add staging-specific tests

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://production.example.com  # Update with your production URL
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate pipeline
        run: |
          python scripts/validate_setup.py

      - name: Run full test suite
        run: |
          pip install -r requirements-dev.txt
          pytest tests/ -v --tb=short

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add your production deployment commands here
          # Examples:
          # - Deploy to production cloud resources
          # - Update production model registry
          # - Blue-green deployment
          # - Canary deployment

      - name: Run production health checks
        run: |
          echo "Running production health checks..."
          # Add production validation tests

      - name: Create release notes
        run: |
          echo "# Release Notes" > dist/RELEASE_NOTES.md
          echo "Version: ${{ github.ref_name }}" >> dist/RELEASE_NOTES.md
          echo "Commit: ${{ github.sha }}" >> dist/RELEASE_NOTES.md
          echo "Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> dist/RELEASE_NOTES.md
          echo "" >> dist/RELEASE_NOTES.md
          echo "## Changes" >> dist/RELEASE_NOTES.md
          # Extract commit messages since last tag
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> dist/RELEASE_NOTES.md || echo "No previous tags found"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Send deployment notification
        run: |
          echo "Deployment completed. Status: ${{ needs.deploy-staging.result }} / ${{ needs.deploy-production.result }}"
          # Add notification logic (Slack, email, etc.)
          # Example:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Deployment completed"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

